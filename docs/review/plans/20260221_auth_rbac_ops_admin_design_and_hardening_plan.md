# 20260221 Auth RBAC Ops-Admin Design and Hardening Plan

- generated_at: 2026-02-21
- scope: Auth + RBAC + Ops/Admin Console + Audit Hardening
- gate: AGENTS.md 12.3 (pre-implementation mandatory)
- status: LOCKED BEFORE CODE CHANGES

## 1) Why
- Existing MVP auth/rbac baseline needs production hardening for cookie session safety, CSRF defense, refresh reuse detection, and operations observability.
- This change modifies security-critical paths and must be fixed by design before code edits.

## 2) Scope
- Backend: auth session lifecycle hardening, RBAC matrix enforcement, Ops dashboard/audit APIs, ops event/metric pipelines.
- Frontend: login + token refresh UX + role-based routing + ops/admin console pages.
- Docs: spec consistency, notion sync, spec_sync_report updates, full implementation report.

## 3) Out of Scope
- Role taxonomy changes (`AGENT/CUSTOMER/ADMIN/OPS/SYSTEM` is fixed).
- Destructive data migrations.
- Any plaintext secret/token handling in logs/docs.

## 4) Security Policy Locks (Must Apply)

### 4.1 Refresh Cookie Path Policy (Locked)
- Refresh cookie path is fixed to `Path=/v1/auth`.
- Reason: `Path=/v1/auth/refresh` prevents cookie send on `/v1/auth/logout`, causing revoke/delete mismatch.
- Both `/v1/auth/refresh` and `/v1/auth/logout` must receive the cookie and perform revoke/delete by cookie first.

### 4.2 SameSite Policy (Locked)
- Default deployment assumption: app/api are same-site under same registrable root domain.
- Default cookie mode: `HttpOnly`, `SameSite=Lax`, `Secure` in production.
- If app/api are fully cross-site domains: switch to `SameSite=None; Secure` and enable strict CSRF defenses (Origin allowlist).

### 4.3 Refresh Body Fallback Policy (Locked)
- `refresh_token` body fallback is deprecated and controlled.
- Production default: OFF.
- dev/test: ON.
- Production exception only for allowlisted `client_type` values (legacy interoperability).
- Every fallback usage must be auditable (`AUTH_REFRESH_FALLBACK_USED`).

### 4.4 CSRF Policy for Refresh/Logout (Locked)
- Refresh/logout require Origin allowlist check.
- Origin-missing default behavior in production: deny.
- Origin-missing exceptions are explicit allowlist-only for trusted non-browser clients with documented client_type.
- Deny/allow decisions must include trace_id and audit linkage.

### 4.5 Ops Metric Ingestion Ownership (Locked)
- `tb_ops_event`: append-only writes from service-layer ops/audit event publisher.
- `tb_api_metric_hourly`: generated by `@Scheduled` aggregation job using idempotent upsert.
- Scheduler cadence: every 1 minute, with hourly bucket recomputation window.
- Re-run safety: unique key + deterministic upsert to guarantee idempotency.

### 4.6 Lockout + Rate-Limit Storage Strategy (Locked)
- Redis: fast counters/windows for login failure and rate-limit decisions.
- DB: authoritative lock state and audit timeline (lock/unlock/fail events).
- Lockout threshold fixed: 5 failures -> 15 minutes lock.
- Redis failure mode: fail-safe path with DB-backed lock state checks + ops alert.

### 4.7 Audit Before/After Sanitization Policy (Locked)
- before/after JSON must pass allowlist serializer or masking sanitizer before storage.
- Plaintext forbidden fields: `password`, `token`, `access_token`, `refresh_token`, `refresh_jti`, `secret`, `api_key`, and equivalent sensitive aliases.
- Enforcement required at code path and DB write policy level.
- Violations must be blocked from persistence.

## 5) Architecture Decisions
- Server-side RBAC is final authority; UI visibility is supplementary only.
- `ADMIN` internal permission levels are represented as `admin_level` and permission matrix, not as extra roles.
- Permission changes increment `permission_version`; stale tokens are rejected and forced to re-auth.

## 6) Regression Paths
1. Logout fails to revoke refresh token due to cookie path mismatch.
2. CSRF bypass on refresh/logout when Origin validation is skipped.
3. Deprecated body refresh accidentally enabled in prod.
4. Duplicate/non-idempotent hourly metric aggregation causing dashboard drift.
5. Lockout inconsistency between Redis counters and DB state.
6. Sensitive values leaked into audit before/after JSON.
7. Permission changes not reflected for active sessions (stale privilege).

## 7) Validation Plan
- Backend auth scenarios: login success/failure, lockout(5/15), refresh rotation, refresh reuse detect, logout revoke.
- RBAC scenarios: deny-before-business-logic 403, permission_version stale token rejection.
- Ops scenarios: event append, hourly upsert idempotency, dashboard summary/series consistency.
- Audit scenarios: before/after sanitization and forbidden-field blocking.
- Frontend scenarios: 401 refresh retry, refresh fail -> login redirect, role guards.
- UTF-8 integrity checks for all newly added docs/spec outputs.

## 8) DoD
- This hardening plan exists before code changes and includes all locked policies above.
- Implementation, tests, spec/notion sync, and reports align with this plan.
- Any conflict with this file is treated as release blocker.

## 9) Rollback Plan
- Rollback order: feature code -> migration adapters -> docs/spec updates.
- Security policy locks remain non-negotiable after rollback.
- If emergency rollback disables a control, compensating deny rules and audit alerts must be enabled immediately.

## 10) Shared Policy Fixed Points (SSOT, 2026-02-21)
1. `permission_version` mismatch (stale) is fixed to `401` (not `403`).
   - error_code: `AUTH_STALE_PERMISSION`
   - trace_id is mandatory in the error payload.
   - frontend behavior: on `401`, attempt refresh once; if refresh fails, redirect to login.
2. Lockout response is fixed to `429` with `error_code=AUTH_LOCKED`.
   - `Retry-After` is computed as `locked_until - now` in seconds.
   - required audit actions: `AUTH_ACCOUNT_LOCKED`, `AUTH_ACCOUNT_UNLOCKED`.
3. Refresh rotation/reuse detection is fixed to DB CAS semantics.
   - success only when `UPDATE ... WHERE consumed_at IS NULL AND revoked_at IS NULL` affects exactly one row.
   - if affected rows is `0`, treat as reuse: return `409`, revoke entire `session_family`, and write audit log.
4. Hourly metric bucket time standard is fixed to `UTC`.
   - scheduler, aggregation, query contract, and reporting all use UTC buckets.
5. Rate-limit Redis key schema is fixed to tenant + IP with one-minute window.
   - key format: `rl:auth:login:{tenant_key}:{ip}:{epoch_minute_utc}`
   - `Retry-After` is remaining seconds until current window ends.
6. Dirty worktree separation tracking is fixed to one method.
   - create `dirty_baseline.patch` at start.
   - final report must include changed-file list compared to this baseline.
7. Frontend anti-loop rule is fixed.
   - `AUTH_STALE_PERMISSION(401)` triggers refresh attempt only once.
   - on refresh failure or same stale error twice consecutively, force immediate login transition.
8. Refresh reuse (`409`) error code is fixed to `AUTH_REFRESH_REUSE_DETECTED`.
   - standard error format must remain unchanged.
9. `tb_api_metric_hourly` upsert unique key is fixed to `(tenant_id, hour_bucket_utc, metric_key)`.
   - only allowlisted `metric_key` values can be aggregated.
10. Login protection priority is fixed to `rate-limit -> lockout`.
    - rate-limit response: `error_code=AUTH_RATE_LIMITED`
    - lockout response: `error_code=AUTH_LOCKED`
