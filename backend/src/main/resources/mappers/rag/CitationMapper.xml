<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aichatbot.rag.domain.mapper.CitationMapper">

    <resultMap id="CitationRowMap" type="com.aichatbot.rag.infrastructure.CitationRow">
        <constructor>
            <arg column="id" javaType="java.lang.String" name="id"/>
            <arg column="tenant_id" javaType="java.lang.String" name="tenantId"/>
            <arg column="message_id" javaType="java.lang.String" name="messageId"/>
            <arg column="chunk_id" javaType="java.lang.String" name="chunkId"/>
            <arg column="rank_no" javaType="_int" name="rankNo"/>
            <arg column="excerpt_masked" javaType="java.lang.String" name="excerptMasked"/>
            <arg column="created_at" javaType="java.time.Instant" name="createdAt"/>
        </constructor>
    </resultMap>

    <insert id="save">
        INSERT INTO tb_rag_citation(
            id,
            tenant_id,
            message_id,
            message_created_at,
            chunk_id,
            rank_no,
            excerpt_masked,
            created_at,
            updated_at
        ) VALUES (#{citationId}, #{tenantId}, #{messageId}, #{messageCreatedAt}, #{chunkId}, #{rankNo},
                  #{excerptMasked}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <select id="findByMessageId" resultMap="CitationRowMap">
        SELECT id, tenant_id, message_id, chunk_id, rank_no, excerpt_masked, created_at
        FROM tb_rag_citation
        WHERE tenant_id = #{tenantId}
          AND message_id = #{messageId}
        ORDER BY rank_no ASC
    </select>

</mapper>
