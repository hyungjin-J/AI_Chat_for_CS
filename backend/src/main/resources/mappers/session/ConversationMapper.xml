<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aichatbot.session.domain.mapper.ConversationMapper">

    <resultMap id="ConversationRowMap" type="com.aichatbot.session.infrastructure.ConversationRow">
        <constructor>
            <arg column="id" javaType="java.lang.String" name="id"/>
            <arg column="tenant_id" javaType="java.lang.String" name="tenantId"/>
            <arg column="channel_id" javaType="java.lang.String" name="channelId"/>
            <arg column="customer_id" javaType="java.lang.String" name="customerId"/>
            <arg column="status" javaType="java.lang.String" name="status"/>
            <arg column="trace_id" javaType="java.lang.String" name="traceId"/>
            <arg column="created_at" javaType="java.time.Instant" name="createdAt"/>
        </constructor>
    </resultMap>

    <insert id="create">
        INSERT INTO tb_conversation(id, tenant_id, channel_id, customer_id, status, trace_id, created_at, updated_at)
        VALUES (CAST(#{conversationId} AS UUID),
                CAST(#{tenantId} AS UUID),
                CAST(#{channelId} AS UUID),
                CAST(#{customerId} AS UUID),
                'active',
                CAST(#{traceId} AS UUID),
                CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <select id="findById" resultMap="ConversationRowMap">
        SELECT id, tenant_id, channel_id, customer_id, status, trace_id, created_at
        FROM tb_conversation
        WHERE tenant_id = CAST(#{tenantId} AS UUID)
          AND id = CAST(#{conversationId} AS UUID)
    </select>

    <select id="estimateSessionTokenUsage" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(LENGTH(COALESCE(message_text, ''))), 0)
        FROM tb_message
        WHERE tenant_id = CAST(#{tenantId} AS UUID)
          AND conversation_id = CAST(#{conversationId} AS UUID)
    </select>

</mapper>
