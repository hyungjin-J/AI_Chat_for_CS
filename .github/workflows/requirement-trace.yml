name: requirement-trace

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    traceability:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install openpyxl

            - name: Fetch base branch for diff
              run: git fetch --no-tags --prune --depth=1 origin "${{ github.base_ref }}"

            - name: Run release check gate
              run: |
                  python scripts/release_check.py \
                    --base-ref "origin/${{ github.base_ref }}" \
                    --head-ref "${{ github.sha }}" \
                    --report-json "docs/release/release_check_report.json"

            - name: Run PII guard scan
              run: python scripts/pii_guard_scan.py

            - name: Run Python tests
              run: python -m unittest discover -s tests -p "*_test.py"

            - name: Run backend tests
              working-directory: backend
              run: |
                  chmod +x gradlew
                  ./gradlew test

            - name: Upload release report artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: release-check-reports
                  path: |
                      docs/release/release_check_report.json
